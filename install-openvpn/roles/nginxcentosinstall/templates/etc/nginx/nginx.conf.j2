user nginx;
worker_processes {{ ansible_processor_cores }};

pid /var/run/nginx.pid;
error_log /var/log/nginx-error.log warn;

events {
	worker_connections 1024;
}

http {
	include mime.types;
	default_type application/octet-stream;

	log_format main '$remote_addr - $remote_user [$time_local] '
	'"$request" $status $bytes_sent '
	'"$http_referer" "$http_user_agent" '
	'"$gzip_ratio"';

	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	server_tokens off;

	fastcgi_intercept_errors on;
	client_max_body_size 50m;

	server {
		listen 80;
		server_name {{ ansible_hostname }};
		rewrite ^ http://{{ ansible_hostname }}$request_uri? permanent;
	}
	server {
			listen 80;
			server_name {{ ansible_hostname }};
			server_name_in_redirect off;

			access_log /var/log/nginx/localhost.access_log;
			error_log /var/log/nginx/localhost.error_log info;

			root PATH_ON_SERVER;
			index index.php index.html index.htm default.html default.htm;
			# Support Clean (aka Search Engine Friendly) URLs
			location / {
					try_files $uri $uri/ /index.php?$args;
			}

			# deny running scripts inside writable directories
			location ~* /(images|cache|media|logs|tmp)/.*\.(php|pl|py|jsp|asp|sh|cgi)$ {
					return 403;
					error_page 403 /403_error.html;
			}
			location ~ \.php$ {
				fastcgi_pass  unix:/var/run/php-fpm/php72-fpm-www.sock;
				fastcgi_index index.php;
				include fastcgi_params;
				fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
				include /etc/nginx/fastcgi.conf;
			}

			# caching of files 
			location ~* \.(ico|pdf|flv)$ {
					expires 1y;
			}

			location ~* \.(js|css|png|jpg|jpeg|gif|swf|xml|txt)$ {
					expires 14d;
			}
		}
	}
}

# wordpress
server {
listen 80;
server_name site1.ru;
root /web/sites/site1.ru/www/;
index index.php index.html index.htm;
access_log /web/sites/site1.ru/log/access.log main;
error_log /web/sites/site1.ru/log/error.log;

location / {
try_files $uri $uri/ /index.php?q=$uri&$args;
}
location ~* ^.+.(js|css|png|jpg|jpeg|gif|ico)$ {
access_log off;
expires max;
}
location ~ \.php$ {
fastcgi_pass unix:/var/run/php-fpm/php5-fpm.sock;
fastcgi_index index.php;

fastcgi_param DOCUMENT_ROOT /web/sites/site1.ru/www/;
fastcgi_param SCRIPT_FILENAME /web/sites/site1.ru/www$fastcgi_script_name;
fastcgi_param PATH_TRANSLATED /web/sites/site1.ru/www$fastcgi_script_name;

include fastcgi_params;
fastcgi_param QUERY_STRING $query_string;
fastcgi_param REQUEST_METHOD $request_method;
fastcgi_param CONTENT_TYPE $content_type;
fastcgi_param CONTENT_LENGTH $content_length;
fastcgi_intercept_errors on;
fastcgi_ignore_client_abort off;
fastcgi_connect_timeout 60;
fastcgi_send_timeout 180;
fastcgi_read_timeout 180;
fastcgi_buffer_size 128k;
fastcgi_buffers 4 256k;
fastcgi_busy_buffers_size 256k;
fastcgi_temp_file_write_size 256k;
}
location = /favicon.ico {
log_not_found off;
access_log off;
}
location = /robots.txt {
allow all;
log_not_found off;
access_log off;
}
location ~ /\.ht {
deny all;
			}
		}
